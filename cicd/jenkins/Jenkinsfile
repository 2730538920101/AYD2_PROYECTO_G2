pipeline {
    agent none

    environment {
        GIT_CREDENTIALS = credentials('Github-credentials')
    }

    stages {
        stage("Checkout") {
            agent {
                kubernetes {
                    label 'git-agent'
                    defaultContainer 'git'
                    yaml """
                    apiVersion: v1
                    kind: Pod
                    metadata:
                      labels:
                        agent: git-agent
                    spec:
                      containers:
                      - name: git
                        image: alpine/git
                        command:
                        - cat
                        tty: true
                    """
                }
            }
            steps {
                script {
                    echo "GIT CHECKOUT STAGE"
                    git url: "https://github.com/2730538920101/AYD2_PROYECTO_G2.git", branch: 'develop', credentialsId: 'Github-credentials'
                }
            }
        }

        stage("Build and Push Docker Image") {
            agent {
                kubernetes {
                    label 'kaniko-agent'
                    defaultContainer 'kaniko'
                    yaml """
                    apiVersion: v1
                    kind: Pod
                    metadata:
                      labels:
                        agent: kaniko-agent
                    spec:
                      containers:
                      - name: kaniko
                        image: gcr.io/kaniko-project/executor:latest
                        args:
                        - --dockerfile=Dockerfile
                        - --context=dir:https://github.com/2730538920101/AYD2_PROYECTO_G2/tree/main/backend/app_service
                        - --destination=docker.io/carlosmz87/ayd2_p1_app_service:latest
                        env:
                        - name: DOCKER_CONFIG
                          value: /kaniko/.docker/
                        volumeMounts:
                          - name: docker-config
                            mountPath: /kaniko/.docker/
                      volumes:
                      - name: docker-config
                        secret:
                          secretName: dockerhub-credentials-secret
                    """
                }
            }
            steps {
                script {
                    echo "BUILD AND PUSH STAGE"
                    // Aqu√≠ Kaniko construye y sube la imagen a Docker Hub
                }
            }
        }
    }
}
